#!/bin/sh -l
# Called by dokku action after app creation but before deployment
# passed APP_NAME, IS_REVIEW_APP, SSH_REMOTE
# https://github.com/dokku/ci-docker-image/blob/a68a9220582cfe7686c7f868bed1441179ecc607/bin/dokku-deploy#L86

if [ "$IS_REVIEW_APP" = "true" ]; then
    if ! ssh "$SSH_REMOTE" -- mysql:exists "$APP_NAME-mysql"; then
        echo "Creating $APP_NAME-mysql instance..."
        ssh "$SSH_REMOTE" -- mysql:create "$APP_NAME-mysql"
        echo "Created $APP_NAME-mysql instance"
    else
        echo "$APP_NAME-mysql instance already exists"
    fi
    if ! ssh "$SSH_REMOTE" -- mysql:linked "$APP_NAME-mysql" "$APP_NAME"; then
        echo "Linking $APP_NAME-mysql instance to the $APP_NAME..."
        ssh "$SSH_REMOTE" -- mysql:link "$APP_NAME-mysql" "$APP_NAME"
        echo "Linked $APP_NAME-mysql to the $APP_NAME"
    else
        echo "$APP_NAME-mysql already linked to the $APP_NAME"
    fi
fi
